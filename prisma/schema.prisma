generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum ROLES {
  USER
  ADMIN
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  firstName String
  lastName  String?
  token     String?
  password  String?
  comments  Comment[]
  role      ROLES     @default(USER)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  votes     Vote[]

  @@map("user")
}

model Company {
  id          String    @id @default(uuid())
  symbol      String    @unique
  companyName String?
  data        Json?
  comments    Comment[]
  votes       Vote[]
  report      Report?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("company")
}

model Comment {
  id        Int      @id @default(autoincrement())
  text      String
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("comment")
}

model Vote {
  id        Int      @id @default(autoincrement())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  positive  Boolean
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, userId])
  @@map("vote")
}

model Report {
  id                      Int                      @id @default(autoincrement())
  companyId               String                   @unique
  executiveSummary        ExecutiveSummary?
  overviewAndStockMetrics OverviewAndStockMetrics?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt

  company                       Company                        @relation(fields: [companyId], references: [id])
  shareHolderStructure          ShareHolderStructure?
  analystRecommendation         AnalystRecommendation?
  equityValuationAndDcfAnalysis EquityValuationAndDcfAnalysis?
  financialStatementAnalyasis   FinancialStatementAnalyasis?

  @@map("report")
}

model ExecutiveSummary {
  id               Int      @id @default(autoincrement())
  reportId         Int      @unique
  report           Report   @relation(fields: [reportId], references: [id])
  summary          String?
  positive         String?
  risk             String?
  currentPrice     String?
  dcfFairValue     String?
  analystConsensus String?
  upside           String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("executive_summary")
}

model OverviewAndStockMetrics {
  id                      Int           @id @default(autoincrement())
  reportId                Int           @unique
  report                  Report        @relation(fields: [reportId], references: [id])
  updatedAt               DateTime      @updatedAt
  stockMetrics            StockMetric[]
  fiftyTwoWeekPerformance String?
  createdAt               DateTime      @default(now())

  @@map(name: "overview_and_stock_metrics")
}

model StockMetric {
  id                        Int                     @id @default(autoincrement())
  overviewAndStockMetricsId Int
  overviewAndStockMetrics   OverviewAndStockMetrics @relation(fields: [overviewAndStockMetricsId], references: [id])
  name                      String
  value                     String
  note                      String
  createdAt                 DateTime                @default(now())
  updatedAt                 DateTime                @updatedAt

  @@map("stock_metric")
}

model ShareHolderStructure {
  id       Int    @id @default(autoincrement())
  reportId Int    @unique
  report   Report @relation(fields: [reportId], references: [id])

  // Share Capital Structure data
  totalShares       String?
  shareCapitalNotes String?

  // Relations
  majorShareholders      MajorShareholder[]
  keyInsiderObservations String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("share_holder_structure")
}

enum ShareHolderType {
  FREE_FLOAT
  INSTITUTIONAL_HOLDINGS
  MANAGEMENT_DIRECTORS

  @@map("share_holder_type")
}

model MajorShareholder {
  id Int @id @default(autoincrement())

  shareHolderStructureId Int
  shareHolderStructure   ShareHolderStructure @relation(fields: [shareHolderStructureId], references: [id], onDelete: Cascade)

  shareHolderType ShareHolderType
  ownership       String
  notes           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("major_shareholder")
}

model AnalystRecommendation {
  id       Int    @id @default(autoincrement())
  reportId Int    @unique
  report   Report @relation(fields: [reportId], references: [id])

  // Relations
  currentConsensus   CurrentConsensus[]
  consensusDetails   ConsensusDetail[]
  recentAnalystViews String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("analyst_recommendation")
}

enum RatingType {
  BUY_OR_STRONG_BUY
  HOLD
  SELL
  TOTAL_ANALYSTS

  @@map("rating_type")
}

enum ConsensusDetailType {
  AVERAGE_PRICE_TARGET
  MEDIAN_PT
  BULL_CASE_PT_TOP
  BEAR_CASE_PT_BOTTOM
  CONSENSUS_RATING

  @@map("consensus_detail_type")
}

model CurrentConsensus {
  id Int @id @default(autoincrement())

  analystRecommendationId Int
  analystRecommendation   AnalystRecommendation @relation(fields: [analystRecommendationId], references: [id], onDelete: Cascade)

  rating            RatingType
  count             String
  percentageOfTotal String
  trend             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("current_consensus")
}

model ConsensusDetail {
  id Int @id @default(autoincrement())

  analystRecommendationId Int
  analystRecommendation   AnalystRecommendation @relation(fields: [analystRecommendationId], references: [id], onDelete: Cascade)

  name  ConsensusDetailType
  value String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("consensus_detail")
}

model EquityValuationAndDcfAnalysis {
  id       Int    @id @default(autoincrement())
  reportId Int    @unique
  report   Report @relation(fields: [reportId], references: [id])

  // Single fields
  keyTakeAway String?

  // Relations
  keyAssumptions          KeyAssumption[]
  projectedFinancialYears ProjectedFinancialYear[]
  dcfValuationBuildup     DcfValuationBuildup?
  valuationSensitivities  ValuationSensitivity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("equity_valuation_and_dcf_analysis")
}

// -------------------- Enums --------------------
enum KeyAssumptionModelName {
  WACC
  TERMINAL_GROWTH_RATE
  FORECAST_PERIOD
  REVENUE_GROWTH

  @@map("key_assumption_model_name")
}

enum FinancialYear {
  FY_2026
  FY_2027
  FY_2028
  FY_2029
  FY_2030

  @@map("financial_year")
}

enum ProjectionMetricType {
  REVENUE_GBP_M
  REVENUE_GROWTH
  PBT_MARGIN_PERCENT
  PBT_GBP_M
  TAX_RATE
  NET_INCOME_GBP_M
  DILUTED_SHARES_M
  DILUTED_EPS_P

  @@map("projection_metric_type")
}

// -------------------- Models --------------------
model KeyAssumption {
  id Int @id @default(autoincrement())

  equityValuationAndDcfAnalysisId Int
  equityValuationAndDcfAnalysis   EquityValuationAndDcfAnalysis @relation(fields: [equityValuationAndDcfAnalysisId], references: [id], onDelete: Cascade)

  modelName  KeyAssumptionModelName
  assumption String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([equityValuationAndDcfAnalysisId, modelName])
  @@map("key_assumption")
}

model ProjectedFinancialYear {
  id Int @id @default(autoincrement())

  equityValuationAndDcfAnalysisId Int
  equityValuationAndDcfAnalysis   EquityValuationAndDcfAnalysis @relation(fields: [equityValuationAndDcfAnalysisId], references: [id], onDelete: Cascade)

  financialYear FinancialYear
  projections   ProjectionMetric[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([equityValuationAndDcfAnalysisId, financialYear])
  @@map("projected_financial_year")
}

model ProjectionMetric {
  id Int @id @default(autoincrement())

  projectedFinancialYearId Int
  projectedFinancialYear   ProjectedFinancialYear @relation(fields: [projectedFinancialYearId], references: [id], onDelete: Cascade)

  metric ProjectionMetricType
  value  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectedFinancialYearId, metric])
  @@map("projection_metric")
}

model DcfValuationBuildup {
  id Int @id @default(autoincrement())

  equityValuationAndDcfAnalysisId Int                           @unique
  equityValuationAndDcfAnalysis   EquityValuationAndDcfAnalysis @relation(fields: [equityValuationAndDcfAnalysisId], references: [id], onDelete: Cascade)

  pvOfFCF           String
  pvOfTerminalValue String
  enterpriseValue   String
  netDebt           String
  equityValue       String
  fairValuePerShare String
  currentPrice      String
  impliedUpside     String
  note              String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dcf_valuation_buildup")
}

model ValuationSensitivity {
  id Int @id @default(autoincrement())

  equityValuationAndDcfAnalysisId Int
  equityValuationAndDcfAnalysis   EquityValuationAndDcfAnalysis @relation(fields: [equityValuationAndDcfAnalysisId], references: [id], onDelete: Cascade)

  wacc   String
  values ValuationSensitivityValue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([equityValuationAndDcfAnalysisId, wacc])
  @@map("valuation_sensitivity")
}

model ValuationSensitivityValue {
  id Int @id @default(autoincrement())

  valuationSensitivityId Int
  valuationSensitivity   ValuationSensitivity @relation(fields: [valuationSensitivityId], references: [id], onDelete: Cascade)

  terminalGrowth String
  value          String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([valuationSensitivityId, terminalGrowth])
  @@map("valuation_sensitivity_value")
}

model FinancialStatementAnalyasis {
  id Int @id @default(autoincrement())

  reportId Int    @unique
  report   Report @relation(fields: [reportId], references: [id])

  // Sections: free-text bullet lists
  keyObservations         String[]
  capitalPositionAnalysis String[]
  fcfQualityAnalysis      String[]
  valuationObservations   String[]

  // Tables
  incomeStatementTrendRows IncomeStatementTrendRow[]
  balanceSheetStrengthRows BalanceSheetStrengthRow[]
  cashFlowAnalysisRows     CashFlowAnalysisRow[]
  financialRatioMetrics    FinancialRatioMetricRow[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("financial_statement_analysis")
}

// -------------------- Financial Statements Enums --------------------
enum FinancialStatementYear {
  FY20
  FY21
  FY22
  FY23
  FY24
  FY25
  FY25_EST

  @@map("financial_statement_year")
}

// -------------------- Financial Statements Models --------------------
model IncomeStatementTrendRow {
  id Int @id @default(autoincrement())

  financialStatementAnalyasisId Int
  financialStatementAnalyasis   FinancialStatementAnalyasis @relation(fields: [financialStatementAnalyasisId], references: [id], onDelete: Cascade)

  fiscalYear      FinancialStatementYear
  revenue         String
  yoyGrowth       String
  operatingIncome String
  netIncome       String
  eps             String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([financialStatementAnalyasisId, fiscalYear])
  @@map("income_statement_trend_row")
}

model BalanceSheetStrengthRow {
  id Int @id @default(autoincrement())

  financialStatementAnalyasisId Int
  financialStatementAnalyasis   FinancialStatementAnalyasis @relation(fields: [financialStatementAnalyasisId], references: [id], onDelete: Cascade)

  fiscalYear         FinancialStatementYear
  cash               String
  totalAssets        String
  totalDebt          String
  shareholdersEquity String
  debtToEquity       String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([financialStatementAnalyasisId, fiscalYear])
  @@map("balance_sheet_strength_row")
}

model CashFlowAnalysisRow {
  id Int @id @default(autoincrement())

  financialStatementAnalyasisId Int
  financialStatementAnalyasis   FinancialStatementAnalyasis @relation(fields: [financialStatementAnalyasisId], references: [id], onDelete: Cascade)

  fiscalYear    FinancialStatementYear
  operatingCF   String
  capex         String
  freeCF        String
  fcfMargin     String
  dividendsPaid String
  shareBuyback  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([financialStatementAnalyasisId, fiscalYear])
  @@map("cash_flow_analysis_row")
}

model FinancialRatioMetricRow {
  id Int @id @default(autoincrement())

  financialStatementAnalyasisId Int
  financialStatementAnalyasis   FinancialStatementAnalyasis @relation(fields: [financialStatementAnalyasisId], references: [id], onDelete: Cascade)

  metric String
  values FinancialRatioValue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([financialStatementAnalyasisId, metric])
  @@map("financial_ratio_metric_row")
}

model FinancialRatioValue {
  id Int @id @default(autoincrement())

  financialRatioMetricRowId Int
  financialRatioMetricRow   FinancialRatioMetricRow @relation(fields: [financialRatioMetricRowId], references: [id], onDelete: Cascade)

  year  FinancialStatementYear
  value String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([financialRatioMetricRowId, year])
  @@map("financial_ratio_value")
}
